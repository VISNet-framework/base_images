name: Build and Push All Dockerfiles

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  list-dockerfiles:
    # find all Dockerfile_* files and outputs them as a matrix.
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all Dockerfile_*
        id: set-matrix
        run: |
          files=$(ls Dockerfile_* | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=$files" >> $GITHUB_OUTPUT
        
  build-and-push:
    # Build and publishes the dockerfiles listed in the previous step
    needs: list-dockerfiles
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile: ${{fromJson(needs.list-dockerfiles.outputs.matrix)}}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert repository name to lowercase
        id: tolower
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ github.repository }}

      - name: Build and push all Dockerfile_* images
        shell: bash
        run: |
          for dockerfile in Dockerfile_*; do
            suffix="${dockerfile#Dockerfile_}"
            imagename="ghcr.io/${{ steps.tolower.outputs.lowercase }}:${suffix}"
            echo "Building $dockerfile as $imagename"
            docker build -f "$dockerfile" -t "$imagename" .
            docker push "$imagename"
          done
